<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<!--
  Browse the glideinWMS RRDs

  Based on
  javascriptrrd/src/lib/rrdJFlot.html 
   Original repository: http://javascriptrrd.sourceforge.net/
-->

<html>
  
    <script type="text/javascript" src="jslibs/binaryXHR.js"></script>
    <script type="text/javascript" src="jslibs/rrdFile.js"></script>
    <script type="text/javascript" src="jslibs/rrdFilter.js"></script>

    <!-- rrdFlot class needs the following four include files !-->
    <script type="text/javascript" src="jslibs/rrdFlotSupport.js"></script>
    <script type="text/javascript" src="jslibs/rrdFlot.js"></script>
    <script type="text/javascript" src="jslibs/jquery.js"></script>
    <script type="text/javascript" src="jslibs/jquery.flot.js"></script>

    <script type="text/javascript" src="jslibs/factory_support.js"></script>
  <head>
    <title>Glidein factory status from logs</title>
  </head>

  <body>
    <table width="100%">
    <tr>
     <td><h1 id="title">Glidein factory status from logs</h1>
     <td align="right">[ 
	    <a href="factoryStatus.html">Status</a> |
	    <a href="factoryCompletedStats.html">Completed stats</a> |
	    <a href="factoryRRDBrowse.html">Browse</a> |
	    <a href="factoryRRDEntryMatrix.html">Entry Matrix</a> 
	    ]
    </tr>
    </table>

    <table border=0>
     <tr>
       <th>Entry</th>
       <td><form id="entries">
	<input type="radio" name="entry" value="total" checked>total<br>
       </form></td>
     </tr>
     <tr>
       <th>Info group</th>
       <td><form id="gtypes">
	<input type="radio" name="gtype" value="running" checked>Running
	<input type="radio" name="gtype" value="idle">Idle
	<input type="radio" name="gtype" value="other">Other
	<input type="radio" name="gtype" value="completed">Completed
       </form></td>
     </tr>
     <tr>
      <td colspan=2><button onclick="fname_update()">Update</button></td>
     </tr>
    </table>

    <hr>

    <table id="infotable" border=1>
        <tr><td colspan="21"><b>Javascript needed for this page to work</b></td></tr>
	<tr><td><b>RRD file</b></td><td id="fname" colspan="5">None</td></tr>
    </table>

    <div id="mygraph"></div>

   <hr>
    <p>Powered by
        <a href="http://oss.oetiker.ch/rrdtool/" target="_blank">RRDTool</a>,
        <a href="https://sourceforge.net/projects/javascriptrrd/" target="_blank">JavascriptRRD</a> and                                                                 <a href="http://code.google.com/p/flot/" target="_blank">Flot</a>.
 
    <script type="text/javascript">

      // Remove the Javascript warning
      document.getElementById("infotable").deleteRow(0);

      // Load the status of the factory
      var factoryQStats=loadFactoryQStats();
      var entries=getFactoryEntries(factoryQStats);
      for (var entry in entries) {
        var elRadio=document.createElement("input");
        elRadio.type = "radio";
        elRadio.name = "entry";
        elRadio.value = entries[entry];

        var html_el=document.getElementById("entries");
        html_el.appendChild(elRadio);
        html_el.appendChild(document.createTextNode(entries[entry]));
      }

     // fname, gtype_id and rrd_data are the global variable used by all the functions below
      rrd_data=undefined;
      gtype_id=undefined;

      // This function updates the Web Page with the data from the RRD archive header
      // when a new file is selected
      function update_plot() {
        // Finally, update the file name and enable the update button
        document.getElementById("fname").firstChild.data=fname;
        

        var gtype_DSs=new Object();
        gtype_DSs['running']=new Array('StatusRunning','EnteredRunning','ExitedRunning','EnteredCompleted','EnteredHeld');
        gtype_DSs['idle']=new Array('StatusIdle','StatusWait','EnteredIdle','ExitedIdle','EnteredWait','ExitedWait','EnteredRunning','EnteredHeld');
        gtype_DSs['other']=new Array('StatusHeld','EnteredHeld','ExitedHeld','EnteredRemoved','EnteredIdle','EnteredRunning')
        gtype_DSs['completed']=new Array('Lasted','CondorLasted','JobsLasted','JobsTerminated','JobsGoodput','Glideins','FailedNr','JobsNr');

        var gtype_formats=new Object();
        gtype_formats['running']={'StatusRunning':{ title: 'Running glideins', label: 'Running', color: "#00f800", checked:true,
                                                    lines: { show: true, fill: true, fillColor:"#00ff00"} },
                                  'EnteredRunning':{title: 'Glidein startup rate', label:'Startup', color: "#008000", yaxis: 2},
                                  'ExitedRunning':{title: 'Glidein termination rate', label:'Termination',color: "#00ffff", yaxis: 2},
                                  'EnteredCompleted':{title: 'Glidein completion rate', label:'Completion', color: "#ffff00", yaxis: 2},
                                  'EnteredHeld':{title: 'Held rate', label:'Held', color: "#ff0000", yaxis: 2}};

        gtype_formats['idle']={'StatusIdle':{ title: 'Idle glideins', label:'Idle', color: "#0000f8", checked:true,
                                              lines: { show: true, fill: true, fillColor:"#0000ff"} },
                               'StatusWait':{ title: 'Waiting glideins', label:'Waiting', color: "#f800f8", checked: true},
                               'EnteredIdle':{title: 'Glidein submission rate', label:'Submission', color: "#00ffff", yaxis: 2},
                               'ExitedIdle':{title: 'Rate out of idle state', label:'Idle out', color: "#000080", yaxis: 2},
                               'EnteredWait':{title: 'Rate into wait state', label:'Wait in', color: "#800080", yaxis: 2},
                               'ExitedWait':{title: 'Rate out of wait state', label:'Wait out', color: "#ff0080", yaxis: 2},
                               'EnteredRunning':{title: 'Rate into running state', label:'Run in', color: "#00c000", yaxis: 2},
                               'EnteredHeld':{title: 'Rate into held state', label:'Held in', color: "#ff0000", yaxis: 2}};

        gtype_formats['other']={'StatusHeld':{ title: 'Held glideins', label:'Abs held', color: "#f80000", checked:true,
                                               lines: { show: true, fill: true, fillColor:"#ff0000"} },
                                'EnteredHeld':{title: 'Glidein held rate', label:'Held rate', color: "#800000", yaxis: 2},
                                'ExitedHeld':{title: 'Glidein release rate', label:'Release', color: "#ff8000", yaxis: 2},
                                'EnteredRemoved':{title: 'Glidein removal rate', label: 'Removal', color: "#ffff00", yaxis: 2},
                                'EnteredIdle':{title: 'Rate into idle state', label: 'Idle in', color: "#0000ff", yaxis: 2},
                                'EnteredRunning':{title: 'Rate into running state', label: 'Run in', color: "#00ff00", yaxis: 2}};

        gtype_formats['completed']={'Lasted':{ title: 'Glideins wallclock time', label:'Lasted', color: "#00f8f8", checked:true,
                                               lines: { show: true, fill: true, fillColor:"#00ffff"} },
                                    'CondorLasted':{ title: 'Condor within glideins wallclock time', label:'Condor Lasted', color: "#008080", checked:false,
                                               lines: { show: true, fill: true, fillColor:"#008484"} },
                                    'JobsLasted':{ title: 'User jobs wallclock time', label:'Jobs Lasted', color: "#0000f8", checked:false,
                                               lines: { show: true, fill: true, fillColor:"#0000ff"} },
                                    'JobsTerminated':{ title: 'Terminated user jobs wallclock time', label:'Jobs Terminated', color: "#008000", checked:true,
                                               lines: { show: true, fill: true, fillColor:"#008400"} },
                                    'JobsGoodput':{ title: 'User jobs goodput', label:'Jobs Goodput', color: "#00c000", checked:false,
                                               lines: { show: true, fill: true, fillColor:"#00c400"} },
                                    'Glideins':{title: 'Number of terminated glideins', label:'Glideins Nr', color: "#000000", yaxis: 2, checked:false},
                                    'FailedNr':{title: 'Number of glideins failing validation', label:'Failed Nr', color: "#ff0000", yaxis: 2, checked:false},
                                    'JobsNr':{title: 'Number of user jobs executed', label: 'Jobs Nr', color: "#c0ff00", yaxis: 2, checked:false}};


        var rrd_data1=new RRDFilterDS(rrd_data,gtype_DSs[gtype_id]);
        // the rrdFlot object creates and handles the graph
        var f=new rrdFlot("mygraph",rrd_data1,null,gtype_formats[gtype_id]);
      }

      // This is the callback function that,
      // given a binary file object,
      // verifies that it is a valid RRD archive
      // and performs the update of the Web page
      function update_plot_handler(bf) {
          var i_rrd_data=undefined;
          try {
            var i_rrd_data=new RRDFile(bf);            
          } catch(err) {
            alert("File "+fname+" is not a valid RRD archive!");
          }
          if (i_rrd_data!=undefined) {
            rrd_data=i_rrd_data;
            update_plot()
          }
      }

      // this function is invoked when the RRD file name changes
      function fname_update() {
        var entry_name="";
        gtype_id=undefined;

        var entries_obj=document.getElementById("entries")
        for (var i in entries_obj.entry) {
         var entry=entries_obj.entry[i];
         if (entry.checked==true) {
  	   entry_name=entry.value;
         }
        }

        var gtypes_obj=document.getElementById("gtypes");
        for (var i in gtypes_obj.gtype) {
         var gtype=gtypes_obj.gtype[i];
         if (gtype.checked==true) {
  	   gtype_id=gtype.value;
         }
        }

        if ((gtype_id=='running') || (gtype_id=='idle') || (gtype_id=='other')) {
          rrd_fname="Log_Counts";
        } else if (gtype_id=='completed') {
          rrd_fname="Log_Completed";
        } else {
          alert("Unknown gtype_id "+gtype_id); // should never enter here
          rrd_fname=none;
        }

        if (entry_name=="total") {
          fname="total/"+rrd_fname+".rrd";
        } else {
          fname="entry_"+entry_name+"/total/"+rrd_fname+".rrd";
        }

        document.getElementById("fname").firstChild.data="Loading "+fname;
        try {
          FetchBinaryURLAsync(fname,update_plot_handler);
        } catch (err) {
           alert("Failed loading "+fname+"\n"+err);
        }
      }
    </script>
  </body>
</html>
